name: CI Microsistemas

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      apps: ${{ steps.filter.outputs.changes }}
      any_app: ${{ steps.filter.outputs.apps }}
      docs: ${{ steps.filter.outputs.docs }}
    steps:
    - uses: actions/checkout@v4
    - uses: dorny/paths-filter@v3
      id: filter
      with:
        filters: |
          apps:
            - 'apps/**'
          docs:
            - '**.md'
            - 'docs/**'
          CapacitySim: 'apps/CapacitySim/**'
          Conversor: 'apps/Conversor/**'
          GitTrainer: 'apps/GitTrainer/**'
          JsTools: 'apps/JsTools/**'
          LogViewer: 'apps/LogViewer/**'
          PhpMigrator: 'apps/PhpMigrator/**'
          SqlViewer: 'apps/SqlViewer/**'
          YmlGenerator: 'apps/YmlGenerator/**'

  lint-docs:
    needs: changes
    if: ${{ needs.changes.outputs.docs == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Markdown Lint
      uses: davidanson/markdownlint-cli2-action@v16
      with:
        config: .markdownlint.json
        globs: "**/*.md"

  lint-php:
    needs: [changes]
    if: ${{ needs.changes.outputs.any_app == 'true' }}
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        tools: php-cs-fixer, phpstan
    - name: Install Dependencies
      run: composer install --no-interaction --prefer-dist
    - name: PHP CS Fixer (Dry Run)
      run: php-cs-fixer fix --dry-run --diff
      continue-on-error: true
    - name: PHPStan
      run: phpstan analyze

  lint-python:
    needs: [changes]
    if: contains(needs.changes.outputs.apps, 'CapacitySim')
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - name: Install Ruff
      run: pip install ruff
    - name: Run Ruff
      run: ruff check .

  build-docker:
    needs: [changes]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      security-events: write
    steps:
      - uses: actions/checkout@v4
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build local image for scanning
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: microsistemas-suite:local

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: 'microsistemas-suite:local'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Build and push suite (Root)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/microsistemas-suite:latest
            ghcr.io/${{ github.repository_owner }}/microsistemas-suite:${{ github.sha }}

      - name: Generate SBOM (Suite)
        uses: anchore/sbom-action@v0
        with:
          image: ghcr.io/${{ github.repository_owner }}/microsistemas-suite:latest
          artifact-name: sbom-suite.json
          output-format: 'spdx-json'

  # Job opcional para micro-apps con Dockerfile
  # Se puede extender con una matriz si se detectan más Dockerfiles
  build-apps-docker:
    needs: [changes]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Detect and build app images
        run: |
          for app_dir in apps/*; do
            if [ -f "$app_dir/Dockerfile" ]; then
              app_name=$(basename "$app_dir")
              echo "Construyendo imagen para $app_name..."
              # Lógica de build/push aquí
            fi
          done
